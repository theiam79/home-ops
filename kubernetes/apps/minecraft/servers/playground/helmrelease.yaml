---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: playground.mc
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: minecraft
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    resources:
      requests:
        cpu: 512m
        memory:  500Mi
    workloadAsStatefulSet: true
    strategyType: RollingUpdate
    serviceAnnotations:
       mc-router.itzg.me/externalServerName: playground.mc.${SECRET_DOMAIN}
    minecraftServer:
      eula: "TRUE"
      type: "FABRIC"
      difficulty: normal
      whitelist:
      ops:
      forcegameMode: true
      gameMode: creative
      modrinth:
        projects:
          - fabric-api
          - chunky
          - bluemap
      extraPorts:
        - name: map
          containerPort: 8100
          protocol: TCP
    persistence:
      dataDir:
        enabled: true
        Size: 5Gi
        existingClaim: playground
    # sidecarContainers:
    #   - |
    #     name: {{ template "minecraft.fullname" . }}-proxy
    #     image: nginx:stable-alpine
    #     ports:
    #     - containerPort: 8080
    #       name: http
    #     volumeMounts:
    #       - name: bluemap-web
    #         mountPath: /web/bluemap
    #         readOnly: true
    #       - name: nginx-conf
    #         mountPath: /etc/nginx/conf.d
    # extraVolumes:
    #   - volumeMounts:
    #       - name: bluemap-web
    #         mountPath: /web/bluemap
    #   - volumeMounts:
    #       - name: bluemap-config
    #         mountPath: /data/config/bluemap
    #     volumes:
    #       - name: bluemap-config
    #         configMap:
    #           name: bluemap-config
    # extraDeploy:
    #   - |
    #     apiVersion: v1
    #     kind: ConfigMap
    #     metadata:
    #       name: bluemap-config # Will be prefixed
    #     data:
    #       core.conf: |
    #         accept-download: true
    #         data: "/web/bluemap"
    #         render-thread-count: 2