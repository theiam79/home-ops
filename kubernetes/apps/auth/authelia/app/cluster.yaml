---
# yaml-language-server: $schema=https://github.com/datreeio/CRDs-catalog/raw/refs/heads/main/postgresql.cnpg.io/cluster_v1.json
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: authelia-pg
  annotations:
    cnpg.io/skipEmptyWalArchiveCheck: "enabled"
spec:
  instances: 1
  imageCatalogRef:
    apiGroup: postgresql.cnpg.io
    kind: ClusterImageCatalog
    major: 17
    name: postgresql
  enableSuperuserAccess: true
  superuserSecret:
    name: authelia-pg-superuser
  storage:
    size: 5Gi
    storageClass: ceph-block
  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 50m
  # After first ScheduledBackup completes, change bootstrap to:
  #   bootstrap:
  #     recovery:
  #       source: authelia-pg-v1
  # and remove the unraid-authelia-pg externalCluster entry.
  bootstrap:
    initdb:
      database: authelia
      owner: authelia
      import:
        type: microservice
        databases:
          - authelia
        source:
          externalCluster: unraid-authelia-pg
  plugins:
    - name: barman-cloud.cloudnative-pg.io
      isWALArchiver: true
      parameters:
        barmanObjectName: authelia-pg-backup
        serverName: authelia-pg-v1
  externalClusters:
    - name: unraid-authelia-pg
      connectionParameters:
        host: "192.168.20.201"
        user: authelia
        dbname: authelia
      password:
        name: authelia-cnpg-secret
        key: UNRAID_PG_PASSWORD
    - name: authelia-pg-v1
      plugin:
        name: barman-cloud.cloudnative-pg.io
        parameters:
          barmanObjectName: authelia-pg-backup
          serverName: authelia-pg-v1
---
apiVersion: barmancloud.cnpg.io/v1
kind: ObjectStore
metadata:
  name: authelia-pg-backup
spec:
  retentionPolicy: "15d"
  configuration:
    destinationPath: "s3://cnpg/authelia/"
    endpointURL: "http://snotra.internal:3900"
    s3Credentials:
      region:
        name: authelia-cnpg-secret
        key: AWS_REGION
      accessKeyId:
        name: authelia-cnpg-secret
        key: AWS_ACCESS_KEY_ID
      secretAccessKey:
        name: authelia-cnpg-secret
        key: AWS_SECRET_ACCESS_KEY
  instanceSidecarConfiguration:
    env:
      - name: AWS_REQUEST_CHECKSUM_CALCULATION
        value: when_required
      - name: AWS_RESPONSE_CHECKSUM_VALIDATION
        value: when_required
---
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: authelia-pg
spec:
  backupOwnerReference: self
  cluster:
    name: authelia-pg
  schedule: "0 0 2 * * *"
  immediate: true
  method: plugin
  pluginConfiguration:
    name: barman-cloud.cloudnative-pg.io
